#!/usr/bin/env python3
"""
pixel-characters.html のピクセルデータをANSI TrueColorターミナルアートに変換し、
launch.sh のバナー用 echo 文を生成する。

▀ (Upper Half Block) を使い、前景色=上ピクセル、背景色=下ピクセルで
16行 → 8行に圧縮表示。
"""

# ピクセルデータ（pixel-characters.html から抽出）
_ = 0

chars = [
    # 総統 (Gold)
    {
        "name": "総統",
        "pal": {1: "#1a1a1a", 2: "#f0c030", 3: "#ffe566", 4: "#c89820", 5: "#2a1608", 6: "#4a3018"},
        "px": [
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,2,1,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,2,1,_,_],
            [_,1,2,2,1,2,2,2,2,2,1,2,2,1,_,_],
            [_,1,2,2,1,2,2,2,2,2,1,2,2,1,_,_],
            [_,1,2,2,2,5,5,2,2,5,5,2,2,1,_,_],
            [_,1,2,5,6,5,5,5,5,5,5,6,5,1,_,_],
            [5,1,5,5,2,2,2,2,2,2,2,2,5,5,1,5],
            [_,1,3,2,2,2,2,2,2,2,2,2,3,1,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,_,1,2,2,1,_,_,_,1,2,2,1,_,_,_],
            [_,_,1,2,4,1,_,_,_,1,4,2,1,_,_,_],
            [_,_,_,1,1,_,_,_,_,_,1,1,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
        ]
    },
    # ハク (White)
    {
        "name": "ハク",
        "pal": {1: "#1a1a1a", 2: "#ffffff", 3: "#f0f0f0", 4: "#cccccc", 5: "#8B6914", 6: "#FFF8E7", 7: "#4A90D9", 8: "#E05050"},
        "px": [
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,1,_,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,2,2,1,2,2,2,2,1,2,2,1,_,_,_],
            [_,1,2,2,1,2,2,2,2,1,2,2,1,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,3,2,2,2,2,2,2,2,2,3,1,5,1,_],
            [_,1,3,2,2,2,2,2,2,2,2,1,5,6,5,1],
            [_,_,1,2,2,2,2,2,2,2,2,1,5,8,7,1],
            [_,_,1,2,2,2,2,2,2,2,2,1,5,7,7,1],
            [_,_,1,2,2,1,_,_,_,1,2,2,1,5,1,_],
            [_,_,1,2,4,1,_,_,_,1,4,2,1,_,_,_],
            [_,_,_,1,1,_,_,_,_,_,1,1,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
        ]
    },
    # ゴーグル (Green)
    {
        "name": "ゴーグル",
        "pal": {1: "#1a1a1a", 2: "#2ecc71", 3: "#58d68d", 4: "#1e8c4a", 5: "#0a3d20", 6: "#44cc80", 7: "#88ffbb", 8: "#ccffe8"},
        "px": [
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,1,_,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [1,5,1,1,1,1,5,5,1,1,1,1,5,1,_,_],
            [1,1,6,7,8,1,5,5,1,6,7,8,1,1,_,_],
            [1,5,1,1,1,1,5,5,1,1,1,1,5,1,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,3,2,2,2,2,2,2,2,2,3,1,_,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,1,_,_,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,1,_,_,_,_],
            [_,_,1,2,2,1,_,_,_,1,2,2,1,_,_,_],
            [_,_,1,2,4,1,_,_,_,1,4,2,1,_,_,_],
            [_,_,_,1,1,_,_,_,_,_,1,1,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
        ]
    },
    # リキニキ (Red)
    {
        "name": "リキニキ",
        "pal": {1: "#1a1a1a", 2: "#e74c3c", 3: "#ff6b6b", 4: "#b83028", 5: "#ff8888"},
        "px": [
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,_,1,2,2,2,2,2,2,2,1,_,_,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,_,1,2,1,2,2,2,2,1,2,2,1,_,_,_],
            [_,_,1,2,1,2,2,2,2,1,2,2,1,_,_,_],
            [1,1,1,2,2,2,2,2,2,2,2,2,1,1,1,_],
            [1,2,1,3,2,2,2,2,2,2,2,3,1,2,1,_],
            [1,5,1,3,2,2,2,2,2,2,2,3,1,5,1,_],
            [1,2,1,1,2,2,2,2,2,2,2,1,1,2,1,_],
            [1,1,_,1,2,2,2,2,2,2,2,1,_,1,1,_],
            [_,_,_,1,2,2,1,_,1,2,2,1,_,_,_,_],
            [_,_,_,1,2,4,1,_,1,4,2,1,_,_,_,_],
            [_,_,_,_,1,1,_,_,_,1,1,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
        ]
    },
    # アオさん (Blue)
    {
        "name": "アオさん",
        "pal": {1: "#1a1a1a", 2: "#3498db", 3: "#5dade2", 4: "#1e6fa0", 5: "#1a1a1a", 6: "#d4eaf7", 7: "#ffffff"},
        "px": [
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,1,_,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,2,5,5,5,2,2,5,5,5,2,1,_,_,_],
            [_,1,2,5,7,6,5,5,5,7,6,5,1,_,_,_],
            [_,1,2,5,5,5,2,2,5,5,5,2,1,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,3,2,2,2,2,2,2,2,2,3,1,_,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,1,_,_,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,1,_,_,_,_],
            [_,_,1,2,2,1,_,_,_,1,2,2,1,_,_,_],
            [_,_,1,2,4,1,_,_,_,1,4,2,1,_,_,_],
            [_,_,_,1,1,_,_,_,_,_,1,1,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
        ]
    },
    # ブラッキー (Black/Purple)
    {
        "name": "ブラッキー",
        "pal": {1: "#1a1a1a", 2: "#3a3a50", 3: "#4a4a62", 4: "#2a2a3a", 5: "#7B2D8E", 6: "#A855C8", 7: "#D4A0E8"},
        "px": [
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
            [_,_,1,2,2,2,2,2,2,2,2,1,_,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,2,2,1,2,2,2,2,1,2,2,1,_,_,_],
            [_,1,2,2,1,2,2,2,2,1,2,2,1,_,_,_],
            [_,1,2,2,2,2,2,2,2,2,2,2,1,_,_,_],
            [_,1,3,2,2,2,2,2,2,2,2,3,1,1,1,_],
            [_,1,3,2,2,2,2,2,2,2,2,1,5,6,5,1],
            [_,_,1,2,2,2,2,2,2,2,2,1,5,7,5,1],
            [_,_,1,2,2,2,2,2,2,2,2,1,5,6,5,1],
            [_,_,1,2,2,1,_,_,_,1,2,2,1,5,1,_],
            [_,_,1,5,4,1,_,_,_,1,4,5,1,_,_,_],
            [_,_,_,1,1,_,_,_,_,_,1,1,_,_,_,_],
            [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
        ]
    },
]


def hex_to_rgb(h):
    h = h.lstrip('#')
    return int(h[0:2], 16), int(h[2:4], 16), int(h[4:6], 16)


def rgb_to_256(r, g, b):
    """RGB → 256色パレット番号に変換。Terminal.appで確実に動く。"""
    # ほぼ黒
    if r < 8 and g < 8 and b < 8:
        return 16
    # グレースケール判定（RGB差が小さい）
    if abs(r - g) < 10 and abs(g - b) < 10 and abs(r - b) < 10:
        gray = (r + g + b) // 3
        if gray > 248:
            return 231
        return round((gray - 8) / 247 * 24) + 232
    # 6x6x6 カラーキューブ
    ri = round(r / 255 * 5)
    gi = round(g / 255 * 5)
    bi = round(b / 255 * 5)
    return 16 + 36 * ri + 6 * gi + bi


def fg256(r, g, b):
    """256色モードの前景色エスケープ"""
    return f"\033[38;5;{rgb_to_256(r, g, b)}m"


RESET = "\033[0m"


def render_char(ch):
    """16x16 ピクセルを 16行の ANSI 文字列に変換。
    256色モード + ██（フルブロック）で描画。
    Terminal.appで確実に色が出る方式。
    """
    lines = []
    for row in range(16):
        line = ""
        cur_code = None

        for col in range(16):
            val = ch["px"][row][col] if row < len(ch["px"]) else 0

            if val == 0:
                if cur_code is not None:
                    line += RESET
                    cur_code = None
                line += "  "
            else:
                r, g, b = hex_to_rgb(ch["pal"][val])
                code = rgb_to_256(r, g, b)
                if code != cur_code:
                    line += f"\033[38;5;{code}m"
                    cur_code = code
                line += "██"

        if cur_code is not None:
            line += RESET
        lines.append(line)
    return lines


def render_row(char_list, spacing=4):
    """複数キャラを横並びで結合"""
    rendered = [render_char(ch) for ch in char_list]
    num_rows = len(rendered[0])  # 16行
    result = []
    for row_idx in range(num_rows):
        parts = []
        for r in rendered:
            parts.append(r[row_idx])
        result.append((" " * spacing).join(parts))
    return result


def generate_banner():
    """バナー用 echo 文を生成（2文字幅、2体×3段レイアウト）"""
    row1 = render_row([chars[0], chars[1]], spacing=4)
    row2 = render_row([chars[2], chars[3]], spacing=4)
    row3 = render_row([chars[4], chars[5]], spacing=4)

    lines = []
    lines.append("")

    # 1段目: 総統 + ハク
    lines.append(f"    echo -e '    \\033[1;33m★ 総統 ★\\033[0m                        \\033[1;37m★ ハク ★\\033[0m'")
    for row in row1:
        escaped = row.replace("\\", "\\\\").replace("'", "'\\''")
        lines.append(f"    echo -e '    {escaped}'")
    lines.append(f"    echo -e '    \\033[1;33mOpus4.6 指揮官\\033[0m                    \\033[1;37mOpus4.6 管理役\\033[0m'")
    lines.append("    echo ''")

    # 2段目: ゴーグル + リキニキ
    lines.append(f"    echo -e '    \\033[1;32m★ ゴーグル ★\\033[0m                    \\033[1;31m★ リキニキ ★\\033[0m'")
    for row in row2:
        escaped = row.replace("\\", "\\\\").replace("'", "'\\''")
        lines.append(f"    echo -e '    {escaped}'")
    lines.append(f"    echo -e '    \\033[1;32mHaiku4.5 偵察役\\033[0m                   \\033[1;31mSonnet4.6 主力\\033[0m'")
    lines.append("    echo ''")

    # 3段目: アオさん + ブラッキー
    lines.append(f"    echo -e '    \\033[1;34m★ アオさん ★\\033[0m                  \\033[0;35m★ ブラッキー ★\\033[0m'")
    for row in row3:
        escaped = row.replace("\\", "\\\\").replace("'", "'\\''")
        lines.append(f"    echo -e '    {escaped}'")
    lines.append(f"    echo -e '    \\033[1;34mSonnet4.6 分析\\033[0m                   \\033[0;35mSonnet4.6 門番\\033[0m'")

    return "\n".join(lines)


def generate_raw_preview():
    """ターミナルプレビュー用の生出力（2文字幅、2体×3段）"""
    row1 = render_row([chars[0], chars[1]], spacing=4)
    row2 = render_row([chars[2], chars[3]], spacing=4)
    row3 = render_row([chars[4], chars[5]], spacing=4)

    # 1段目: 総統 + ハク
    print(f"\n    \033[1;33m★ 総統 ★\033[0m                        \033[1;37m★ ハク ★\033[0m")
    for row in row1:
        print(f"    {row}")
    print(f"    \033[1;33mOpus4.6 指揮官\033[0m                    \033[1;37mOpus4.6 管理役\033[0m")
    print()

    # 2段目: ゴーグル + リキニキ
    print(f"    \033[1;32m★ ゴーグル ★\033[0m                    \033[1;31m★ リキニキ ★\033[0m")
    for row in row2:
        print(f"    {row}")
    print(f"    \033[1;32mHaiku4.5 偵察役\033[0m                   \033[1;31mSonnet4.6 主力\033[0m")
    print()

    # 3段目: アオさん + ブラッキー
    print(f"    \033[1;34m★ アオさん ★\033[0m                  \033[0;35m★ ブラッキー ★\033[0m")
    for row in row3:
        print(f"    {row}")
    print(f"    \033[1;34mSonnet4.6 分析\033[0m                   \033[0;35mSonnet4.6 門番\033[0m")
    print()


# エージェントID → chars index のマッピング
AGENT_MAP = {
    "shogun": 0, "総統": 0,
    "karo": 1, "ハク": 1,
    "ashigaru1": 2, "ゴーグル": 2,
    "ashigaru2": 3, "リキニキ": 3,
    "ashigaru3": 4, "アオさん": 4,
    "ashigaru4": 5, "ブラッキー": 5,
}

# エージェントごとの色コード
AGENT_COLORS = {
    0: "1;33",  # 総統: 黄
    1: "1;37",  # ハク: 白
    2: "1;32",  # ゴーグル: 緑
    3: "1;31",  # リキニキ: 赤
    4: "1;34",  # アオさん: 青
    5: "0;35",  # ブラッキー: 紫
}


def render_single_agent(agent_key):
    """1体のエージェントアバターを表示（ペイン用）"""
    idx = AGENT_MAP.get(agent_key)
    if idx is None:
        print(f"Unknown agent: {agent_key}")
        return

    ch = chars[idx]
    color = AGENT_COLORS[idx]
    lines = render_char(ch)

    print(f"\033[{color}m{'─' * 36}\033[0m")
    print(f"\033[{color}m    ★ {ch['name']} ★\033[0m")
    print(f"\033[{color}m{'─' * 36}\033[0m")
    for row in lines:
        print(f"  {row}")
    print(f"\033[{color}m{'─' * 36}\033[0m")
    print()


if __name__ == "__main__":
    import sys
    if "--preview" in sys.argv:
        generate_raw_preview()
    elif "--agent" in sys.argv:
        idx = sys.argv.index("--agent")
        if idx + 1 < len(sys.argv):
            render_single_agent(sys.argv[idx + 1])
        else:
            print("Usage: --agent <agent_id|name>")
    else:
        print(generate_banner())
